#!/usr/bin/perl -w
# vi: set ts=4 sw=4 :
#____________________________________________________________________________
#
#	MusicBrainz -- the open music metadata database
#
#	Copyright (C) 2001 Robert Kaye
#
#	This program is free software; you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation; either version 2 of the License, or
#	(at your option) any later version.
#
#	This program is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#
#	You should have received a copy of the GNU General Public License
#	along with this program; if not, write to the Free Software
#	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
#	$id: $
#____________________________________________________________________________


use strict;

use FindBin;
use lib "$FindBin::Bin/../cgi-bin";

use MusicBrainz::Server::CollectionInfo;
use MusicBrainz::Server::Release;
use Data::Dumper;


# log in
require MusicBrainz;
my $mbraw = MusicBrainz->new();
$mbraw->Login(db => 'RAWDATA');
my $mbro = MusicBrainz->new();
$mbro->Login();


# set up SQL identifiers
my $sqlraw = Sql->new($mbraw->{dbh});
my $sqlro = Sql->new($mbro->{dbh});


# select all collections that shall receive notifications by e-mail
my $collections = $sqlraw->SelectSingleColumnArray('SELECT id FROM collection_info WHERE emailnotifications = TRUE');

#print 'collections:'.Dumper($collections);

# iterate over all collections to be notified and send out e-mails(if any new releases)
foreach my $currentCollectionId (@$collections)
{
	use MusicBrainz::Server::CollectionPreference;
	my $currentPreferences = MusicBrainz::Server::CollectionPreference->new($mbro->{dbh}, $mbraw->{dbh}, MusicBrainz::Server::CollectionInfo::GetUserIdForCollection($currentCollectionId, $mbraw->{dbh}));
	
	my $currentCollection = MusicBrainz::Server::CollectionInfo->newFromCollectionId($currentCollectionId, $mbro->{dbh}, $mbraw->{dbh}, $currentPreferences);
	
	# get new releases
	my $newReleases = $currentCollection->GetNewReleases();
	
	# update the lastcheck attribute of the collection_info table
	$currentCollection->UpdateLastCheck();
	
	my $count = @{$newReleases};
	
	#print Dumper($newReleases);
	
	my $userId = $currentCollection->GetUserId();
	
	#print "count: $count \n";
	
	if($count>0) # notifications should be sent
	{
		#print 'SENDING NOTIFICATION';
		sendMail($currentCollection, $newReleases, $userId, $mbro->{dbh});
	}
}


exit 1;

{
	my %cache;

	sub get_artist
	{
		my ($id, $rodbh) = @_;
		if (not exists $cache{$id})
		{
			$cache{$id} = MusicBrainz::Server::Artist->newFromId($rodbh, $id);
		}
		return $cache{$id};
	}
}

sub sendMail
{
	my ($collectionId, $releaseIds, $userId, $rodbh) = @_;
	
	#my $user = UserStuff->newFromId();
	
	#print Dumper(@$releaseIds);
	my $subject = 'New releases';
	my $message = '<html><body>The following Releases are about to be (or have recently been) released:<br/>';

	$message .= "<ul>\n";

	require MusicBrainz::Server::Validation;
	my $html = \&MusicBrainz::Server::Validation::encode_entities;
	
	for my $releaseId (@{$releaseIds})
	{
		my $release = MusicBrainz::Server::Release->new($rodbh);
		$release->SetId($releaseId);
		$release->LoadFromId();

		my $artist = get_artist($release->GetArtist, $rodbh);

		#print $release->GetName()."\n";
		
		$message = $message . sprintf qq[<li><a href="%s">%s</a> by <a href="%">%s</a></li>\n],
			&$html($release->GetInfoURL),
			&$html($release->GetName),
			&$html($artist->GetInfoURL),
			&$html($artist->GetName),
			;
	}

	$message .= "</ul>\n";
	
	# finish message
	my $server = &DBDefs::WEB_SERVER;
	$message = $message . '<br/><br/>This email was automatically generated by $server because you have subscribed to be notified on new Releases of selected Artists. If you want to unsubscribe go to <a href="http://$server/user/collectionpreferences.html">http://$server/user/collectionpreferences.html</a><br/></body></html>';
	
	
	require UserStuff;
	my $user = UserStuff->new($rodbh);
	$user = $user->newFromId($userId);
	


	require MusicBrainz::Server::Mail;
	my $mail = MusicBrainz::Server::Mail->new(
		# Sender: not required
		From		=> 'MusicBrainz Collection Robot <noreply@musicbrainz.org>',
		# To: $user (automatic)
		"Reply-To"	=> 'MusicBrainz Support <support@musicbrainz.org>',
		Subject		=> "New releases",
		Type		=> "text/html",
		Encoding	=> "quoted-printable",
		Data		=> $message,
	);
    $mail->attr("content-type.charset" => "utf-8");


	#$user->SendFormattedEmail(entity => $mail);
	
	
	#print $message;
}


=head1 NAME
	SendReleaseNotifications - Send e-mail notifications about new releases
	
	=head1 DESCRIPTION
	Iterate over all users who have selected to have e-mail notifications sent and notify them by email about new releases.

	=cut
